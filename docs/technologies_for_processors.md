# 本
- [プロセッサを支える技術　－－果てしなくスピードを追求する世界 (WEB+DB PRESS plus) | Hisa Ando](https://amzn.to/2VHhcgf)

# 1章: プロセッサとコンピュータシステムの基礎
- コンピュータの基本構造、データの表現、命令の説明
- 半導体技術の進歩の概観（ムーアの法則とデナードスケーリング）
- プロセッサの性能向上の3本柱は「クロック周波数の向上」「並列処理」「機能拡張」
- コンパイラを使うプログラミングとインタプリタによるプログラミングの違い

# 2章: プロセッサの変遷
- コンピュータコンピュータ以前の計算装置（そろばんや機械式）と初期の電子式コンピュータ。関係ないけど Computer History Museum いつかまた行きたいと思った
- プロセッサを構成する素子の変遷（真空管 → トランジスタ → 集積回路 → 大規模集積回路）とそれぞれの特徴
- 1971年の Intel4004 と2010年のマイクロプロセッサとの比較
  - トランジスタの数: 2300 → 数億〜数十億
  - 配線幅: 10μm → 50nm（1/200）
  - クロック周波数: 740kHz → 3GHz（4000倍）
- VLSI のプロセッサ数は20年で10000倍（1.5年で倍）の増加傾向、クロック周波数は10年で10〜20倍の傾向。ただしクロック周波数は消費電力の制約から、向上のペースは鈍化している
- 命令アーキテクチャの発展
  - プログラム内蔵式コンピュータ / 仮想メモリ / マルチプロセス / メモリ管理機構 / 特権状態 / ISA 拡張
- マイクロアーキテクチャの発展
  - パイプライン処理 / 演算器の高速化 / RISC と CISC / スーパースカラ実行 / Out-of-Order 実行 / 分岐予測 / キャッシュ / マルチコア

# 3章: [詳説] プログラマのためのプロセッサアーキテクチャ
- マイクロアーキテクチャを支える技術
  - パイプライン実行の仕組み
    - パイプラインで問題となるのは「構造的ハザード」「データハザード」「制御ハザード」
    - 構造的ハザード: 「プロセッサの資源を取り合う」問題
      - 「命令に優先度をつける」「資源を追加する」ことで対応
    - データハザード: 「前の仕事が終わらないと次に進めない」問題
      - 1サイクルで演算できるものはレジスタバイパスで対応
      - 複雑な演算はソフトウェアパイプライン処理で対応
    - 制御ハザード: 「条件分岐命令」問題
      - 関数のインライン展開（コール / リターンを減らす）、ループアンローリング（条件分岐を減らす）で対応
  - キャッシュの仕組み
    - タグとキャッシュラインで管理、メモリとキャッシュ間のデータ転送はキャッシュライン単位でまとめて行う
    - キャッシュの方式
      - フルアソシアティブ方式（インデックスなし） / ダイレクトマップ方式（ラインアドレスごとに1つのキャッシュライン） / セットアソシアティブ方式（複数のキャッシュライン）
      - 参考: [【図解あり】キャッシュメモリを分かりやすく説明する | Yone's Archive](https://elite-lane.com/cache-memory/)
  - RISC と CISC
    - CISC 命令だと命令のデコードが難しく、またパイプライン実行が難しい
    - x86 では CISC 命令を RISC 風の内部命令に変換してから実行（互換性を維持）
    - RISC の特徴はロード命令とユース命令を引き離すことで無駄な待ち時間を減らせることと、命令の格納に多くのメモリを必要とすること（2〜3割程度）
  - 演算器の高速化
    - 整数加算器の高速化: プリフィックスアダーを利用（32ビットの加算の場合、全体で18段程度の論理ゲートとなり、25段以内なので3GHzクロックなら1サイクルで実行できる）
    - 整数乗算器の高速化: ブースエンコードとウォレスツリーを組み合わせると、64ビットの乗算の場合、合計3ステージ程度
    - 除算の高速化: SRT除算アルゴリズムで速くなるが、それでも時間がかかるので、できるだけ除算を使わないようにしたり、除算同士が近接しなように気をつけたりすることが大切
  - スーパースカラ実行の仕組み（構造的ハザードを解消する）
    - 1サイクルに複数の命令を並列に実行するプロセッサをスーパースカラプロセッサ、その動作をスーパースカラ実行と呼ぶ
    - 最近のハイエンドプロセッサでは、4〜6命令を並列に実行する
    - スーパースカラプロセッサでは、「連続する複数の命令が並列に実行できるかどうか」がポイントとなる
  - Out-of-Order の仕組み（データハザードの影響を軽減する）
    - 機械命令の順番を崩して、後の命令でも実行可能な命令を先にやってしまうのが Out-of-Order 実行
    - Out-of-Order 実行を行うためにリザベーションステーションという機構が用いられる
    - ただし、逆依存性の問題がある。逆依存性がある場合、命令の順序を入れ替えて実行してしまうと、結果が変わってしまう
    - 逆依存性にはリネーム処理で対応する。また例外発生時は直前の状態に戻せるようにする
    - またメモリバリア命令を設けて、実行順序を保証する
  - 分岐予測の仕組み（制御ハザードによる損失を低減する）
    - 分岐予測は、プロセッサが条件分岐命令の分岐方向を予測し、予測した方向の命令を読み出し、解釈、実行していく技術
    - 飽和カウンタを使う方法 / 履歴を使う方法（ローカル履歴、グローバル履歴）などがある
  - メモリ、I/O と入出力インタフェース
    - 2009年に発売された Nehalem アーキテクチャ以前の Intel プロセッサでは、コモンバスという方式が使われていた
    - コモンバスはコマンドバス・アドレスバス・データバスの3つのバスを持つ
    - 欠点は以下
      - 一時には1つの装置しかバスを使えない
      - 多くの装置を接続するので電気的にも高速の動作が難しく、最高でも 1GHz 程度のデータ伝送に制限される
      - バンド幅を確保するためには多数のピンを必要とする
    - これらの欠点に対応するため、最近のプロセッサでは「メモリコントローラをプロセッサチップに内蔵し、メモリ専用のインタフェースを設けて DIMM を直結する」形になっている
    - 入出力装置を制御する I/O 制御レジスタをメモリ空間に置く方式はメモリマップド I/O と呼ばれる
  - パフォーマンスカウンタ
    - プロファイラによって、関数ごとに全体の何%の場合で実行中であったかという情報を出力できる
    - パフォーマンスカウンタによって、プロセッサが実行した命令数、各レベルのキャッシュのアクセス回数、各キャッシュのミス回数、実行された条件分岐命令、予測ミスとなった条件分岐命令などの値をカウントできる
- プロセッサの利用範囲を広げるアーキテクチャ拡張
  - マルチプログラミングとメモリ管理機構
    - メモリ上に細かい空き領域が散らばって多数残ってしまい、空き領域の合計は大きいが、新しいプログラムを入れられないような状態をフラグメンテーションという
    - この問題の対応として、ページ方式のメモリ管理が行われる
    - 論理ページとそれに対応する物理アドレスや属性の情報を、ページテーブルに記録する
    - ページテーブル用のキャッシュを TLB という
    - ページテーブルを現実的なサイズに抑えるために、多階層のアドレス変換を行う
  - 割り込み処理機構
    - プロセッサの正常な命令実行の流れを中断する必要がある事象を「例外」。以上の原因となっている命令が特定できる例外を「トラップ」、特定できない例外を「割り込み」と呼ぶ
    - ポーリング: OS がステータスレジスタの状態を読んで動作状態を知り、完了していない場合は、またある程度の時間をおいて読むことで、I/O 動作の完了を知る方法
    - 割り込み: 動作が完了したら I/O コントローラのほうからプロセッサに完了連絡をする。割り込みメカニズムは、I/O 動作の完了以外にもエラーが行った場合の異常終了の通知などにも使われる。
    - 割り込みには様々なものがあるので、緊急度を考慮して高速に割り込み処理ができるように改良したものを「ベクタ割り込み」という。また、割り込み緊急度を示す情報を「割り込みレベル」という
  - 仮想化のサポート
    - OS レベルでの分離を行うために、VMM というレイヤを設けて、1つのプロセッサハードウェアを複数のハードウェアがあるように見せる「仮想化」という方法が考えられた
  - マルチメディア、暗号などのサポート
    - 1つの命令で複数の演算器に同じ動作をさせる並列処理のやり方を「SIMD」という
    - DES に代わる新しい標準暗号となる共通鍵暗号アルゴリズムとして制定されたのが「AES」という暗号方式
- x86 Nehalem アーキテクチャのプロセッサ
  - x86 の命令体系、Intel 64アーキテクチャについて
    - ここでは IA-32e 64ビットモードを中心に解説を進める
    - SIMDデータを保持するのが XMM レジスタ、SSE 演算の制御と状態を示すのが MXCSR レジスタ
    - x86 プロセッサの命令形式を確認
      - Prefix / REX Prefix / OP Code / Mod R/M / SIB
  - Core i7プロセッサの構成
    - 2010年時点で、Intel プロセッサの最新のアーキテクチャは Nehalem アーキテクチャと呼ばれる
    - 命令フェッチとプリデコードからデコードまでの部分が、命令を供給する「フロントエンド」と呼ばれる部分
    - 命令実行を行う「実行エンジン」では、リネームからはじまり、リオーダバッファ・リザベーションステーション・レジスタを介して、実行パイプラインに送られる
    - 最後の「キャッシュ階層」では1次命令キャッシュ・1次データキャッシュ・2次キャッシュ・3次キャッシュを持つ
  - メモリ管理は4階層のテーブルを使用
    - 4階層アドレス変換機構で、ページテーブルを管理。これでページテーブルに必要なメモリ量を大幅に削減
  - 新しいプロセッサインタフェース QPI
    - 複数の CPU チップ間を接続してマルチソケットシステムを構成する場合のインタフェースとして QPI と呼ぶ高速伝送インタコネクトを使う。これはコモンバスではなく、1対1の接続とすることで、高速伝送を可能にしている