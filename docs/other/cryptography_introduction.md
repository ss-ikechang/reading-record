# 概要

## 本

- [暗号技術入門 | 結城 浩](https://amzn.to/3jVkxmH)

## かかった時間

- xxx 時間

## 進め方

- xxx

## 感想

- xxx

# 読書メモ

# 第 1 部: 暗号

## 1: 暗号の世界ひとめぐり

### 暗号

- 暗号は機密性を守る

### 対称暗号と公開鍵暗号

- 対称暗号(symmetric cryptography)と公開鍵暗号(public-key cryptography)
  - 「対称暗号」は暗号化と復号化で同じ鍵を使う方式
  - 「公開鍵暗号」は暗号化と復号化で異なる鍵を使う方式
    - このため公開鍵暗号は、「非対称暗号(asymmetric cryptography)」と呼ぶこともある
- ハイブリッド暗号システム(hybrid cryptography)
  - 対称暗号と公開鍵暗号を組み合わせた暗号方式が「ハイブリッド暗号システム」

### その他の暗号技術

- 一方向ハッシュ関数(詳しくは 7 章)
  - 書き換えを防止するため、セキュリティを意識しているプログラムの提供者は、プログラムを広く公開すると共に、そのプログラムのハッシュ値というものも公開する場合がある
  - ハッシュ値とは「一方向ハッシュ関数」を使って計算した値
  - 一方向ハッシュ関数が提供しているものは、機密性ではなく「正真性(integrity)」。正真性は完全性とも呼ばれる
  - 一方向ハッシュ関数を使えば、データが改ざんされていないかどうかを調べられる
- メッセージ認証コード(message authentication code。詳しくは 8 章)
  - メッセージが期待した通信相手から来たものであることを確かめるために、「メッセージ認証コード」という技術が使われる
  - メッセージ認証コードを使うと、そのメッセージが改ざんされていないことと、期待した通信相手からのものであることを確かめられる
  - 正真性だけでなく、「認証(authentication)」も提供してくれる
- デジタル署名
  - 改ざん、否認という脅威を防ぐ技術が「デジタル署名」
    - 否認: 自分の主張をあとで翻すこと。メールを送ったのに、送ってないと主張するなど
  - メールの場合、送信者がデジタル署名を施してメールを送り、受信者はデジタル署名を検証する。これによって、正真性を確かめ、認証と否認防止を行う
- 疑似乱数生成器(pseudo random number generator: PRNG)
  - 「疑似乱数生成器」は、乱数列を擬似的に生成するアルゴリズム

### 暗号学者の道具箱

- 以下の 6 つの技術は特に重要な役割を果たす
  - 対称暗号
  - 公開鍵暗号
  - 一方向ハッシュ関数
  - メッセージ認証コード
  - デジタル署名
  - 疑似乱数生成器

### ステガノグラフィ(steganography)と電子透かし

- メッセージの内容を読めないようにするのではなく、メッセージの存在そのものを隠してしまうのが「ステガノグラフィ」
  - しかし、いったんメッセージの埋め込み方法が解明されてしまうと、メッセージの内容はすぐにわかってしまう
  - なので、ステガノグラフィは暗号の代わりにはならない
- 最近では、「電子透かし」という技術にステガノグラフィが使われる
  - 電子透かしとは、ファイルの中に著作権者や購入者の情報を埋め込む技術
  - 電子透かし技術だけでは、情報を機密にしておくことはできないので、他の技術と組み合わせる必要がある
- 例えば暗号とステガノグラフィを組み合わせるのは、よく使われる
  - まず、埋め込みたい文章を暗号化して暗号文を作る
  - その上で、ステガノグラフィを使って暗号文を画像ファイルの中に隠す
  - このようにすれば、暗号文の存在に気づかれても、埋め込みたい文章の内容は読まれない

### 暗号とセキュリティの常識

- 以下は暗号を学び始めた人が最初にひっかかるポイント
- **秘密の暗号アルゴリズムは使うな**
  - 秘密のアルゴリズムではなく、公開されていて強い暗号アルゴリズムを使うべき
  - 理由 1: 暗号アルゴリズムの秘密は必ず暴かれる
    - 歴史的に、暗号アルゴリズムの秘密が暴かれなかった例は 1 つもない
    - 暗号アルゴリズムそのものを秘密にして機密性を保とうとしている暗号システムは、暗号アルゴリズムの詳細が暴かれてしまったら終わり
  - 理由 2: 強い暗号アルゴリズムを生み出すことは非常に困難
    - 数学のように、暗号アルゴリズムの強さを証明することはできない。専門の暗号解読者たちが、その暗号アルゴリズムを解読しようと何年も試みて失敗した、という事実だけが暗号の強さを示す
- **弱い暗号は暗号化しないよりも危険である**
  - ユーザーが「暗号」という言葉によって「誤った安心感」を抱きやすいため
- **どんな暗号もいつかは解読される**
  - どんな暗号アルゴリズムで作った暗号文でも、すべての鍵をしらみ潰しに試すことによって、いつかは必ず解読される
- **暗号はセキュリティのほんの一部である**
  - 暗号アルゴリズムが破られなくても、メールの内容を知る方法は無数にある
  - 複雑なシステムは、たくさんのリンクが繋がった鎖のようなもの。システムの強さは、最も弱いリンクの強さにほかならない
  - そして、最も弱いリンクは暗号ではなく人間

## 2: 歴史上の暗号

### シーザー暗号(Caesar cipher)

- 「シーザー暗号」は紀元前 100 年頃にローマで生まれ、活躍した武将シーザーが使っていたと言われる暗号
- シーザー暗号では、平文で使われているアルファベットを、一定の文字数だけずらすことによって暗号化を行う
- ブルートフォースアタック(brute-force attack)
  - すべての鍵の候補を試す暗号解読の方法
  - 全数探索(exhaustive search)、総当り法、しらみつぶし法などと呼ばれる

### 単一換字暗号(simple substitution cipher)

- 平文を構成するアルファベットを別のアルファベットへ変換する暗号のことを「単一換字暗号」と呼ぶ。シーザー暗号は単一換字暗号の 1 つ
- 単一換字暗号は、ブルートフォースアタックで解読することは困難
  - シーザー暗号に比べ、はるかに多くの鍵の候補を持つため
- ある暗号で使うことができる「すべての鍵の集合」のことを「鍵空間(keyspace)」といい、可能な鍵の総数のことを鍵空間の大きさという
- 頻度分析による解読
  - 暗号文に使われている文字の頻度を調べて解読する

### エニグマ

- 「エニグマ(enigma)」はドイツのシェルビウスによって 20 世紀のはじめに発明された、暗号化・復号化を行う機械
- エニグマの構造(p35)
  - エニグマは打鍵ごとに 3 枚のローターが回転して回路が変化するあみだくじのようなもの

### なぜ暗号アルゴリズムと鍵とを分けるのか

- 暗号アルゴリズムの中には「変更可能な部分」が必ず含まれる
  - この「変更可能な部分」が「鍵」に相当する
- もし、暗号化を行うたびに新しい暗号アルゴリズムを生み出さなければならないとしたら大変。私達は一度開発した暗号アルゴリズムを繰り返し使いたい
  - しかし、同じ暗号を繰り返し使っていると解読される可能性が高くなる
  - なので、暗号アルゴリズムに「変更可能な部分」を用意しておき、通信ごとにそれを変える。それが「鍵」

## 3: 対称暗号(共通鍵暗号)

### 文字の暗号からビット列の暗号へ

- 符号化(encoding)
  - 現実世界にあるものをビット列に対応付けることを「符号化」と呼ぶ
- XOR(exclusive or)
  - 排他的論理和
  - 0 XOR 0 = 0 / 0 XOR 1 = 1 / 1 XOR 0 = 1 / 1 XOR 1 = 0
  - 同じビット列を 2 回 XOR で重ねると、元に戻る。この性質は暗号化・復号化の手順によく似ている

### 使い捨てパッド - 絶対に解読できない暗号

- 使い捨てパッド(one-time pad)
  - 使い捨てパッドは、ブルートフォースアタックで鍵空間をすべて探索したとしても絶対に解読できない暗号
  - 使い捨てパッドは「平文と、ランダムなビット列との XOR をとる」というだけのシンプルな暗号
- 使い捨てパッドは解読できない
  - もし復号が行われたとしても、「それが正しい平文なのかどうか判定できない」というのが特徴
  - 解読不可能であることは 1949 年に数学的に証明され、使い捨てパッドは無条件に安全であり(unconditionally secure)、理論的に解読不可能(theoretically unbreakable)
- 使い捨てパッドはバーナム暗号(Vernam cipher)とも呼ばれる
- 使い捨てパッドはなぜ使われないのか
  - 使い捨てパッドは非常に使いにくい暗号のため、実際にはほとんど使われない
  - 問題点
    - 鍵の配送
    - 鍵の保存
    - 鍵の再利用ができない
    - 鍵の同期
    - 鍵の生成
  - 以上の理由から、使い捨てパッドが用いられるのは、鍵の生成と配送に莫大なお金と手間をかけることができ、機密性が最優先事項である場合のみ
  - このように、使い捨てパッドは実用的な暗号ではないが、このアイデアはストリーム暗号(stream cipher)に生かされている。ストリーム暗号について詳しくは 4 章で扱う

### DES

- DES(Data Encryption Standard) とは
  - DES は 1977 年にアメリカの連邦情報処理標準規格に採用された対称暗号
  - コンピュータの進歩のため、現在はブルートフォースアタックで解読できるレベルまで落ちてしまった
- 暗号化・復号化
  - DES は 64 ビットの平文を 64 ビットの暗号文に暗号化する対称アルゴリズム。鍵のビット長は 56 ビット(鍵は 64 ビットだが、7 ビットおきにエラー検出のための情報が 1 ビット入るので実質的に 56 ビット)
  - DES では 64 ビットの平文をまとめて暗号化する。このまとまりを「ブロック」と呼ぶ
    - ブロック単位で処理を行う暗号アルゴリズムは「ブロック暗号(block cipher)」と呼ぶので、DES はブロック暗号の一種になる
- DES の構造(ファイステルネットワーク)
  - ファイステルネットワークでは、ラウンドと呼ばれる暗号化の 1 ステップを何度も繰り返す
  - DES は、ラウンドを 16 回繰り返すファイステルネットワーク
- 1 ラウンドは以下のように進む
  - ラウンドへの入力を、左と右とに分ける
  - 右をそのまま右に送る
  - 右をラウンド関数 f に送る
  - ラウンド関数 f は、右とサブ鍵を使って、ランダムに見えるビット列を計算する
  - 得られたビット列と、左との XOR を計算した結果を暗号化された左とする
- ファイステルネットワークの性質
  - 好きなだけラウンド数を増やせる
  - ラウンド関数 f にどんな関数を使っても、復号化が可能
    - つまりラウンド関数 f そのものは出力から入力が逆算できなくても良い
  - 暗号化と復号化が全く同じ構造で実現できる
- 差分解読法と線形解読法
  - ブロック暗号に対する暗号解読法の 1 つに「差分解読法」がある
    - これは「平文の一部を変更すると暗号文がどう変化するか」を調べる暗号解読法
    - 暗号文の変化の偏りを調べて、解読の手がかりを得る
  - 線形解読法
    - 「平文と暗号文のビットをいくつか XOR して 0 になる確率を調べる」という解読方法
    - 暗号文が十分にランダムになっているなら、平文と暗号文のビットをいくつか XOR した結果が 0 になる確率は 1/2 のはず。そこで 1/2 からのずれが大きいビットの箇所を調べて、鍵に関する情報を得ようというもの
  - 差分解読法や線形解読法では、暗号解読者が任意の平文を暗号化できるという仮定を置く。このことを「選択平文攻撃(Chosen Plaintext Attack: CPA)」という

### トリプル DES

- トリプル DES(triple-DES)とは何か(p64)
  - DES よりも強力になるよう、DES を 3 段重ねにした暗号アルゴリズム
- トリプル DES の暗号化
  - 「暗号化 -> 暗号化 -> 暗号化」ではなく「暗号化 -> 復号化 -> 暗号化」と処理する
  - トリプル DES で 3 つの鍵をすべて等しくすると、トリプル DES はただの DES に等しくなる
- トリプル DES の復号化
  - 暗号化の逆の順で復号化できる
- トリプル DES の現状
  - 銀行などでまだ使われているが、処理スピードはあまり高くない

### AES の選定プロセス

- AES とは何か
  - AES(Advanced Encryption Standard) はこれまで標準であった DES に代わって、新しい標準となる対称暗号アルゴリズム
  - 世界中の企業や学者から AES の候補としてアルゴリズムが提案され、その中から「Rijndael」という対称アルゴリズムが 2000 年に AES として選定された

### Rijndael

- Rijndael とは何か
  - ベルギーの研究者が設計したブロック暗号アルゴリズムで、2000 年に次世代の標準アルゴリズム AES として選定された
  - AES は世界中で広く使われている対称暗号アルゴリズムであり、どんな暗号ソフトウェアも AES をサポートしているはず
- Rijndael の暗号化と復号化
  - Rijndael は DES と同じく、複数のラウンドから構成される
  - ファイステルネットワークではなく、「SPN 構造」という構造が使われている
  - 1 ラウンドは以下の 4 つの処理を行う
    - SubBytes(バイトごとの置換)
    - ShiftRows(行のシフト)
    - MixColumns(列の混合)
    - AddRoundKey(ラウンド鍵との XOR)
- どの対称暗号を使えばよいのか
  - DES は新しい用途には使うべきではない
  - トリプル DES も新しい用途に使うべきではない
  - 現在使うなら AES が良い
  - 一般に自作のアルゴリズムも使うべきではない

### まとめ

- 大きな鍵空間を持ち、アルゴリズム上の弱点を持たない対称暗号を用いると、暗号文によって平文の機密性を守れる
- しかし、対称暗号を使って通信を行うためには、鍵を安全に受信者に送らなければならないという鍵配送問題が残る
  - この問題の解決のためには、公開鍵暗号の技術が必要になる

## 4: ブロック暗号のモード

### ブロック暗号のモード

- 暗号アルゴリズムはブロック暗号とストリーム暗号の 2 つに分けられる
  - 「ブロック暗号(block cipher)」はある特定のビット数の「まとまり」を一度に処理する暗号アルゴリズムの総称
    - この「まとまり」のことを「ブロック」と呼ぶ
    - 例えば DES やトリプル DES のブロック長は 64 ビット、AES は 128 ビット
  - 「ストリーム暗号(stream cipher)」はデータの流れを順次処理していく暗号アルゴリズムの総称
    - ストリーム暗号では、1 ビット・8 ビット・32 ビットなどの単位で暗号化や復号化が行われる
  - ブロック暗号は、ブロック単位で処理が完了するので、どこまで暗号化が進んだかという内部状態を持つ必要はない
  - 一方、ストリーム暗号はデータの流れを順次処理していくので、内部状態を持つ
- モードとは何か
  - 長い平文を暗号化するためには、ブロック暗号アルゴリズムを繰り返し使って、長い平文全部を暗号化する必要がある
    - この繰り返しの方法のことを、ブロック暗号の「モード」と呼ぶ
  - ブロック暗号の主なモードは以下の 5 種類
    - ECB モード: Electronic CodeBook mode(電子符号表モード)
    - CBC モード: Cipher Block Chaining mode(暗号ブロック連鎖モード)
    - CFB モード: Cipher-FeedBack mode(暗号フィードバックモード)
    - OFB モード: Output-FeedBack mode(出力フィードバックモード)
    - CTR モード: CounTeR mode(カウンタモード)
- 平文ブロックと暗号文ブロック
  - 平文ブロック: ブロック暗号アルゴリズムで暗号化の対象となる平文のこと
  - 暗号文ブロック: ブロック暗号アルゴリズムを使って平文ブロックを暗号化した暗号文

### ECB モード

- ECB モードとは何か(Electronic CodeBook mode、電子符号表モード)
  - ECB モードでは、平文ブロックを暗号化したものが、そのまま暗号文ブロックになる
  - 同じ平文ブロックは、同じ暗号文ブロックに変換される。つまり「平文ブロック→暗号文ブロック」という巨大な対応表を想定できる
  - ここから電子符号表モードという名前がついた
- ECB モードの特徴
  - たくさんあるモードの中でも最もシンプルで、最も機密性が低い
- ECB モードへの攻撃
  - 攻撃者マロリーは暗号を解読せずに平文を操作できる
  - 任意の暗号文ブロックを入れ替えると、対応する平文ブロックが入れ替わってしまう

### CBC モード

- CBC モードとは何か(Cipher Block Chaining mode、暗号ブロック連鎖モード)
  - 暗号ブロックをチェーンのように連鎖させる
  - CBC モードでは 1 つ前の暗号文ブロックと平文ブロックの XOR をとってから暗号化を行う
- 初期化ベクトル
  - 最初の平文ブロックを暗号化するときには「1 つ前の暗号文ブロック」は存在しないので、代わりのビット列を 1 ブロック分用意する必要がある
  - このビット列のことを「初期化ベクトル(initialization vector)」または IV と呼ぶ
  - 初期化ベクトルには、暗号化のたびに異なるランダムなビット列を用いるのが普通
- CBC モードの特徴
  - 平文ブロック 1 と 2 の値が等しい場合でも、暗号文ブロック 1 と 2 の値が等しくなるとは限らない
    - ECB モードが持つ欠点は、CBC モードにはない
  - 復号化のときに、もし暗号文ブロックが 1 つ破損したとすると、平文ブロックに与える影響は 2 ブロック
  - もし暗号文ブロックでビットの欠落があったとすると、その暗号文ブロックの長さは変化してしまい、それ以降のブロックの区切りはずれてしまう。この場合、以降の暗号文ブロックはすべて復号化できなくなる
- CBC モードへの攻撃
  - もしマロリーが初期化ベクトルの任意のビットを反転できるなら、そのビットに対応する平文ブロックのビットを反転させられる
  - 初期化ベクトルに対してマロリーの攻撃は可能だが、暗号文ブロックに対する同様の攻撃は困難
- パディングオラクル攻撃
  - ブロック暗号では、平文の長さがブロックサイズの整数倍にならない時、最後のブロックにパディング(詰め物)というデータが必要になる場合がある
  - 攻撃者はパディング内容を少しずつ変化させて暗号文を何度も送信する
  - 受信者は正しく平文に復号化できなかった場合にエラーを返すので、それを使って平文の情報の一部を得ようとする
  - この攻撃は、CBC に限らず、パディングを行うモードすべてに使える
  - 実際に、この攻撃は 2014 年に大問題になった
  - 暗号文が平文を知っている相手によって正しく生成されたものであることを認証すれば、この攻撃を防げる

### CFB モード

- CFB モードとは何か(Cipher-FeedBack mode、暗号フィードバックモード)
  - 1 つ前の暗号文ブロックを暗号アルゴリズムの入力に使う
  - 平文ブロックと暗号文ブロックの間にあるのは XOR だけ
- CFB モードとストリーム暗号
  - 使い捨てパッドに近い。使い捨てパッドの「ランダムなビット列」に相当するのが、CFB モードでは「暗号アルゴリズムの出力」
  - CFB モードで暗号アルゴリズムが生成するビット列のことを「鍵ストリーム(key stream)」と呼ぶ
  - CFB モードでは、平文のデータを 1 ビットずつ暗号化できる。CFB モードではブロック暗号を使ってストリーム暗号を作っているとみなすこともできる
- CFB モードの復号化
  - CFB モードで復号化を行う場合、ブロック暗号アルゴリズムそのものは暗号化を行う
- CFB モードへの攻撃
  - 「再生攻撃(replay attack)」が可能
  - 古い暗号文を保存しておいて、混ぜ込むことができる

### OFB モード

- OFB モードとは何か(Output-FeedBack mode、出力フィードバックモード)
  - 暗号アルゴリズムの出力を暗号アルゴリズムの入力へフィードバックする
- CFB モードと OFB モードの比較
  - CFB モードと OFB モードでは、暗号アルゴリズムの入力だけが違う
  - CFB モードでは、暗号文ブロックをフィードバックするため、はじめの平文ブロックから順番に暗号化していく必要がある
  - OFB モードでは、平文ブロックとは無関係に暗号アルゴリズムを前もってぐるぐる回し、XOR するためのビット列を準備しておくことができる
    - なので準備しておけば、暗号化を高速に行える

### CTR モード

- CTR モード(CounTeR mode、カウンタモード)
  - 1 ずつ増加していくカウンタを暗号化して、鍵ストリームを作り出すストリーム暗号
- OFB モードと CTR モードの比較
  - CTR モードは OFB モードと同じストリーム暗号の一種
  - OFB モードでは暗号化の出力を入力にフィードバックするが、CTR モードではカウンタの値が暗号化の入力になる
- CTR モードの特徴
  - CTR モードの暗号化と復号化はまったく同じ構造になる。これは OFB モードと同じストリーム暗号の特徴
  - CTR モードでは、ブロックを任意の順番で暗号化・復号化できる。「カウンタ」はノンスとブロック番号からすぐに求めることができるため
    - これは OFB モードにはなかった性質
- エラーと機密性
  - CTR モードでは、能動的攻撃者マロリーが暗号文ブロックのビットを反転させることで、復号化した時の平文ブロックのビットを反転できてしまう
    - OFB モードと同じ弱点
  - OFB モードでは、鍵ストリームの 1 ブロックを暗号化した結果が、暗号化前の結果とたまたま同じになってしまうと、それ以降、鍵ストリームはまったく同じ値の繰り返しになってしまう
    - CTR ではその心配はない

### どのモードを使うべきか

- ECB は使うべきではない
- 比較表は p107 にあり
