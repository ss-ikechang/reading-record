# 概要

## 本

- [体系的に学ぶ 安全なWebアプリケーションの作り方 | 徳丸 浩](https://amzn.to/2S268sV)
- 参考
  - [【正誤情報】体系的に学ぶ安全なWebアプリケーションの作り方 第2版](https://www.sbcr.jp/support/14647/)

## かかった時間

- xxx 時間

## 進め方

- xxx

## 感想

- xxx

# 読書メモ

## 1: Web アプリケーションの脆弱性とは

### 1.1: 脆弱性とは「悪用できるバグ」

- 悪用の例
  - 個人情報などの秘密情報を勝手に閲覧する
  - Web サイトの内容を書き換える
  - サイトを閲覧した利用者の PC をウイルスに感染させる
  - 別の利用者になりすまし、秘密情報の閲覧、投稿、買い物、送金などを行う
  - Web サイトのコンピュータ資源を勝手に使われる(暗号通貨のマイニングなど)
  - Web サイトを利用不能にする
  - オンラインゲームなどで無敵になることができる、アイテムを好きなだけとれる
  - 自分の個人情報を確認したら、他人の個人情報が見えてしまう

### 1.2: 脆弱性があるとなぜ駄目なのか

- 経済的損失
- 法的な要求
- 利用者が回復不可能なダメージを受ける場合が多い
- Web サイト利用者に嘘をつくことになる
- ボットネットワーク構築に荷担する

### 1.3: 脆弱性が生まれる理由

- 脆弱性の発生原因は以下の 2 種類に分類できる
  - バグによるもの
  - チェック機能の不足によるもの

### 1.4: セキュリティバグとセキュリティ機能

- アプリケーションのセキュリティを確保するためには、バグをなくすだけでは不十分な場合がある
  - HTTPS で暗号化していない状態はバグではないが、盗聴される可能性がある
- 積極的に安全性を強化する機能のことを本書では「セキュリティ機能」と呼ぶ

### 1.5: 本書の構成

### 1.6: セキュリティガイドラインとの対応

## 2: 実習環境のセットアップ

- wasbook をインストールしたが、起動時に「VirtualBox VM quit unexpectedly.」のメッセージでエラーが出た
  - Settings > Audio にいって "Enable Audio" のチェックを外したら起動できるようになった
  - Ubuntu 20.04 ではないが同じ症状の記事
    - [How to fix "VirtualBox VM quit unexpectedly" when running my Ubuntu 20.04 LTS VM on MacOS Catalina 10.15 in VirtualBox? - Unix & Linux Stack Exchange](https://unix.stackexchange.com/questions/609077/how-to-fix-virtualbox-vm-quit-unexpectedly-when-running-my-ubuntu-20-04-lts-vm)

## 3: Web セキュリティの基礎

### 3.1: HTTP とセッション管理

- なぜ HTTP を学ぶのか
  - Web の特性に由来する脆弱性を理解するためには、HTTP やセッション管理についての理解が不可欠
- GET と POST の使い分け
  - GET
    - GET メソッドは参照(リソースの取得)のみに用いる
    - GET メソッドは副作用がないことが期待される
    - 秘密情報の送信には POST メソッドを用いること
  - 秘密情報を POST で送信すべきという理由は、GET の場合は以下の可能性があるため
    - URL 上に指定されたパラメータが Referer 経由で外部に漏洩する
    - URL 上に指定されたパラメータがアクセスログに残る
    - URL 上のパラメータがブラウザのアドレスバーに表示され他人にのぞかれる
    - パラメータつきの URL を利用者がソーシャルネットワークなどで共有してしまう
  - 以下が 1 つでも当てはまる場合に POST メソッドを用い、1 つも当てはまらない場合には GET メソッドを利用するとよい
    - データ更新など副作用を伴うリクエストの場合
    - 秘密情報を送信する場合
    - 送信するデータの総量が多い場合
- ステートレスな HTTP 認証
- クッキーとセッション管理
  - HTTP とういプロトコルはステートレスなもので、サーバー側では状態を保持しない
  - しかし、アプリケーションでは状態を保持したい要求がたびたびある
  - HTTP 認証を使えば、ブラウザ側で ID とパスワードを記憶してくれるが、HTTP 認証を使わない場合は、サーバー側で認証状態を覚えておく必要がある
    - これらアプリケーションの状態を覚えておくことをセッション管理という
  - このセッション管理を HTTP で実現する目的でクッキー(cookie)という仕組みが導入された
  - クッキーによるセッション管理
    - クッキーは少量のデータをブラウザ側で覚えておけるものだが、アプリケーションデータを保持する目的でクッキーそのものに値を入れることはあまり行われない
    - 理由
      - クッキーが保持できる値の個数や文字列長には制限がある
      - クッキーの値は利用者本人には参照・変更できるので、秘密情報の格納には向かない
  - セッション ID に求められる要件
    - 第三者がセッション ID を推測できないこと
    - 第三者からセッション ID を強制されないこと
      - 認証後にセッション ID を変更すればよい
    - 第三者にセッション ID が漏洩しないこと
      - セッション ID をネットワーク盗聴から保護するには TLS(Transport Layer Security) による暗号化が有効
  - クッキーの属性
    - Domain 属性
      - ブラウザがクッキー値を送信するサーバーのドメイン
      - Domain 属性を指定しない場合、クッキーを生成したサーバーにのみクッキーが送られる
        - Domain 属性を指定しない状態が最もクッキーの送信範囲が狭く、安全な状態といえる
      - Domain を不用意に設定すると脆弱性の原因になる
        - 例えば example.com がレンタルサーバー事業者であり、foo.example.com と bar.example.com がレンタルサーバー上で運営されている Web サイトであるとする。foo.example.com サイトが発行するクッキーに Domain = example.com と指定してしまうと、このクッキーは bar.example.com にも漏洩してしまう
      - Domain 属性は通常は設定しない
    - Secure 属性
      - Secure という属性をつけたクッキーは、HTTPS 通信の場合のみサーバーに送信される
      - 一方、Secure 属性のついていないクッキーは、HTTPS 通信かどうかに関係なく、常にサーバーに送信される
      - クッキーの Secure 属性は、クッキーの HTTPS 送信を保証する目的で指定される
    - HttpOnly 属性
      - HttpOnly 属性は、JavaScript からアクセスできないクッキーを設定する
      - クッキーとして格納されたセッション ID を盗み出す攻撃の典型例は、クロスサイト・スクリプティング攻撃により JavaScript を悪用してクッキーを盗み出すというもの
      - クッキーに HttpOnly 属性をつけておくと、JavaScript によりクッキーを盗み出すことができなくなる
      - HttpOnly 属性をつけることによる悪影響は通常ないので、セッション ID には HttpOnly 属性をつけるようにするといい
    - SameSite 属性
      - 最近のブラウザには、主にクロスサイド・リクエストフォージェリ(CSRF)脆弱性対策を目的として、SameSite 属性が機能として追加されている
      - SameSite 属性は値として Strict、Lax、None のいずれかを指定できる
        - Strict: 他のドメインへのリクエストを送る場合、Strict が指定されたクッキーはセットされない
        - Lax: top-level navigation でかつ GET メソッドであれば、他のドメインへのリクエストであってもクッキーをセットする
        - None: 従来どおりの動作(クッキーを送る)
